/**
 * Thunderpush javascript client
 * @version v0.9.2 - 2014-11-25 * @link https://github.com/thunderpush/thunderpush-js
 * @author Krzysztof Jagiełło
 * @license MIT License, http://www.opensource.org/licenses/MIT
 */var isMSIE=0,Thunder=new function(){this.channels=[],this.handlers=[],this.handler_events=[],this.reconnect_delays=[1e3,2500,5e3,1e4,3e4,6e4],this.options={log:!1,retry:!0};var a=function(){function a(a,b){this.thunder=a,this.name=b}return a.prototype.bind=function(a,b){this.thunder.bind(this.name,a,b)},a.prototype.unbind=function(a,b){this.thunder.unbind(this.name,a,b)},a}(),b=Array.prototype,c=Object.prototype,d=Function.prototype,e=(b.push,b.slice,b.concat,c.toString,c.hasOwnProperty,b.forEach,b.map,b.reduce,b.reduceRight,b.filter,b.every,b.some,b.indexOf),f=(b.lastIndexOf,Array.isArray,Object.keys,d.bind,function(a){return a instanceof f?a:this instanceof f?void(this._wrapped=a):new f(a)});"function"!=typeof/./&&(f.isFunction=function(a){return"function"==typeof a}),f.identity=function(a){return a},f.lookupIterator=function(a){return f.isFunction(a)?a:function(b){return b[a]}},f.sortedIndex=function(a,b,c,d){c=null==c?f.identity:f.lookupIterator(c);for(var e=c.call(d,b),g=0,h=a.length;h>g;){var i=g+h>>>1;c.call(d,a[i])<e?g=i+1:h=i}return g},f.indexOf=function(a,b,c){if(null==a)return-1;var d=0,g=a.length;if(c){if("number"!=typeof c)return d=f.sortedIndex(a,b),a[d]===b?d:-1;d=0>c?Math.max(0,g+c):c}if(e&&a.indexOf===e)return a.indexOf(b,c);for(;g>d;d++)if(a[d]===b)return d;return-1},this.onSockOpen=function(a){"function"==typeof a&&(this.onopen=a)},this.onSockError=function(a){"function"==typeof a&&(this.onerror=a)},this.onSockClose=function(a){"function"==typeof a&&(this.onclose=a)},this.onSockMessage=function(a){"function"==typeof a&&(this.onmessage=a)},this.connect=function(a,b,c,d){this.server="http://"+a+"/connect",this.apikey=b,this.channels=c,this.reconnect_tries=0;for(var e in d)this.options[e]=d[e];this.user=this.options.user,this.makeConnection()},this.disconnect=function(){var a=this;return this.socket.onclose=function(b){this.onclose&&this.onclose.call(a,b)},this.socket.readyState===SockJS.OPEN?this.socket.close():!1},this.subscribe=function(b,c,d){if("string"!=typeof b||b.length<=0)throw{name:"channel.invalid",message:"Channel is not a string"};if(this.socket.readyState===SockJS.OPEN)return-1!==f.indexOf(this.channels,b)?("function"==typeof c&&c(new a(this,b),"Channel already subscribed"),!0):(this.socket.send("SUBSCRIBE "+b),this.channels.push(b),"function"==typeof c&&c(new a(this,b),"Channel subscribed"),!0);throw"function"==typeof d&&d(this,"Socket not open"),{name:"socket.status",message:"Socket not OPEN: ".this.socket.readyState}},this.unsubscribe=function(a,b,c){if(this.socket.readyState===SockJS.OPEN){this.socket.send("UNSUBSCRIBE "+a);var d=f.indexOf(this.channels,a);return-1!==d&&(channels=this.channels.splice(d,1)),"function"==typeof b&&b(this,"Channel unsubscribed"),!0}var c="";throw"function"==typeof c&&c(this,"Socket not open"),{name:"socket.status",message:"Socket not OPEN: ".this.socket.readyState}},this.listen=function(a){this.log("New handler has been registered."),this.handlers.push(a)},this.bind=function(a,b,c){this.log("New handler has been registered to event '"+b+"' and channel '"+a+"'."),this.handler_events.push([a,b,c])},this.unbind=function(a,b,c){var d,e,f=[];for(this.log("Removes handler registered to event '"+b+"' and channel '"+a+"'."),d=this.handler_events.length,e=d-1;e>=0;d--)this.handler_events[e][0]!==a||b&&this.handler_events[e][1]!==b||c&&this.handler_events[e][2]!==c||(f.push(this.handler_events.splice(e,1)),e--);return f},this.makeConnection=function(){var a=this;this.socket=new SockJS(this.server,void 0,{debug:this.options.log}),this.socket.onopen=function(b){a.log("Connection has been estabilished."),a.onopen&&a.onopen.call(a,b),a.reconnect_tries=0,a.socket.send("CONNECT "+a.user+":"+a.apikey),a.channels.length&&a.socket.send("SUBSCRIBE "+a.channels.join(":"))},this.socket.onmessage=function(b){var c,d;a.log("Message has been received",b.data),a.onmessage&&a.onmessage.call(a,b),channel=b.data.channel,event=b.data.event;try{var e=JSON.parse(b.data.payload);b.data=e}catch(b){}if(null!==event&&void 0!==event&&null!==channel&&void 0!==channel)for(d=a.handler_events.length,c=0;d>c;c++)a.handler_events[c][0]===channel&&a.handler_events[c][1]===event&&a.handler_events[c][2](b.data,channel,event);else for(d=a.handlers.length,c=0;d>c;c++)a.handlers[c](b.data)},this.socket.onerror=function(b){a.onerror&&a.onerror.call(a,b)},this.socket.onclose=function(b){if(a.log("Connection has been lost."),a.onclose&&a.onclose.call(a,b),a.options.retry===!1)return void a.log("Reconnect supressed because of retry option false");if(9e3==b.code||9001==b.code||9002==b.code)return void a.log("Reconnect supressed because of:",b);var c=a.reconnect_delays[a.reconnect_tries]||a.reconnect_delays[a.reconnect_delays.length-1];a.log("Reconnecting in",c,"ms..."),a.reconnect_tries++,setTimeout(function(){a.makeConnection()},c)}},this.log=function(){if(this.options.log&&"console"in window&&"log"in window.console)if(1==arguments.length)console.log(arguments[0]);else if(isMSIE){var a=Function.prototype.bind.call(console.log,console);a.apply(console,Array.prototype.slice.call(arguments))}else console.log.apply(console,Array.prototype.slice.call(arguments))}};